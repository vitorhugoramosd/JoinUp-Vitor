<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprar Ingressos - Sistema de Eventos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">Sistema de Eventos</h1>
            <div class="nav-links">
                <a href="index.html">Eventos</a>
                <span id="userInfo"></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="form-container" style="max-width: 800px;">
            <h2>Comprar Ingressos</h2>

            <div id="alertBox" style="display: none;"></div>

            <div id="eventInfo" style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
                <h3 id="eventName" style="margin-bottom: 10px;"></h3>
                <p id="eventDetails"></p>
                <p><strong>Preço unitário:</strong> R$ <span id="ticketPrice">0.00</span></p>
            </div>

            <form id="purchaseForm" onsubmit="handlePurchase(event)">
                <div class="form-group">
                    <label for="quantity">Quantidade de Ingressos</label>
                    <input type="number" id="quantity" min="1" max="10" value="1" required onchange="updateAttendeeFields()">
                    <small style="color: #666;">Máximo 10 ingressos por compra</small>
                </div>

                <div id="attendeesContainer" class="attendees-container">
                    <!-- Campos dos participantes serão adicionados aqui -->
                </div>

                <div style="background: #e8f5e9; padding: 20px; border-radius: 5px; margin: 30px 0; text-align: center;">
                    <h3 style="margin: 0;">Total: R$ <span id="totalAmount">0.00</span></h3>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="history.back()">Cancelar</button>
                    <button type="submit" class="btn-primary">Finalizar Compra</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_TICKET = 'http://localhost:8080';
        const API_EVENT = 'http://localhost:8080';
        let currentEvent = null;
        let ticketPrice = 0;

        window.onload = function() {
            // Verificar autenticação
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                alert('Você precisa estar logado para comprar ingressos');
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('userInfo').innerHTML =
                `<span style="margin-right: 15px;">Olá, ${user.firstName || user.email}</span>`;

            loadEventInfo();
        };

        async function loadEventInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('eventId');

            if (!eventId) {
                alert('ID do evento não fornecido');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${API_EVENT}/api/events/${eventId}`);
                currentEvent = await response.json();

                document.getElementById('eventName').textContent = currentEvent.name;
                document.getElementById('eventDetails').textContent =
                    `${new Date(currentEvent.eventDate).toLocaleDateString('pt-BR')} - ${currentEvent.location}`;
                document.getElementById('ticketPrice').textContent = currentEvent.ticketPrice.toFixed(2);

                ticketPrice = currentEvent.ticketPrice;

                updateAttendeeFields();
            } catch (error) {
                console.error('Erro ao carregar evento:', error);
                alert('Erro ao carregar informações do evento');
            }
        }

        function updateAttendeeFields() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const container = document.getElementById('attendeesContainer');
            container.innerHTML = '';

            for (let i = 0; i < quantity; i++) {
                const attendeeDiv = document.createElement('div');
                attendeeDiv.className = 'attendee-item';
                attendeeDiv.innerHTML = `
                    <h4>Participante ${i + 1}</h4>
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" class="attendee-name" required>
                    </div>
                    <div class="form-group">
                        <label>CPF (apenas números) *</label>
                        <input type="text" class="attendee-cpf" required maxlength="11" pattern="[0-9]{11}"
                               placeholder="12345678909" onkeypress="return isNumberKey(event)">
                        <small style="color: #666;">Digite 11 dígitos sem pontos ou traços</small>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" class="attendee-email" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Nascimento *</label>
                        <input type="date" class="attendee-birthdate" required>
                    </div>
                `;
                container.appendChild(attendeeDiv);
            }

            updateTotalAmount();
        }

        function updateTotalAmount() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const total = quantity * ticketPrice;
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type}`;
            alertBox.innerHTML = message;
            alertBox.style.display = 'block';
            window.scrollTo(0, 0);
        }

        async function handlePurchase(event) {
            event.preventDefault();

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('jwt_token');
            const quantity = parseInt(document.getElementById('quantity').value);

            // Coletar dados dos participantes
            const attendees = [];
            const attendeeItems = document.querySelectorAll('.attendee-item');

            attendeeItems.forEach((item, index) => {
                const name = item.querySelector('.attendee-name').value;
                const cpf = item.querySelector('.attendee-cpf').value;
                const email = item.querySelector('.attendee-email').value;
                const birthDate = item.querySelector('.attendee-birthdate').value;

                attendees.push({
                    fullName: name,
                    cpf: cpf,
                    email: email,
                    birthDate: birthDate
                });
            });

            const purchaseData = {
                eventId: currentEvent.id,
                userId: user.id,
                quantity: quantity,
                attendees: attendees
            };

            try {
                const response = await fetch(`${API_TICKET}/api/tickets/purchase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(purchaseData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(
                        `<strong>Compra realizada com sucesso!</strong><br>
                        Código da compra: ${result.id}<br>
                        Total: R$ ${result.totalAmount.toFixed(2)}<br>
                        Você receberá os ingressos por email.`,
                        'success'
                    );

                    // Limpar formulário e redirecionar após 3 segundos
                    setTimeout(() => {
                        window.location.href = `index.html`;
                    }, 3000);
                } else {
                    const error = await response.text();
                    showAlert(`Erro ao processar compra: ${error}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao realizar compra:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o gateway está rodando na porta 8080.', 'error');
            }
        }
    </script>
</body>
</html>
